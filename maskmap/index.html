<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
        integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@900&display=swap" rel="stylesheet">
    <title>口罩地圖</title>
    <style>
        #map {
            height: 100%;
            /* position: relative; */
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .col-4 {
            height: 95%;
            position: absolute;
            z-index: 1;
        }
    </style>

</head>

<body class="overflow-hidden">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">

        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <img src="/computer/img/market.png" alt="" width="30" height="30">
                    </a>

                    <div class="dropdown-menu border-0 rounded-0" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="#">開發者介紹</a>
                        <a class="dropdown-item" href="#">你喜歡冰淇淋嗎?</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#">問題回報</a>
                    </div>
                </li>
                <li class="navbar-item dropdown active">
                    <a class="nav-link ml-3" href="#" id="navbarDropdown" role="button" data-toggle="dropdown">
                        口罩地圖<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-filter-left" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M2 10.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5zm0-3a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm0-3a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5z"/>
                          </svg>
                    </a>
                    <div class="dropdown-menu border-0 rounded-0" aria-labelledby="navbarDropdown">
                        <a class="dropdown-item" href="/computer/computer.html">計算機</a>
                        <a class="dropdown-item" href="/cal/cal.html">行事曆</a>
                        <a class="dropdown-item" href="/Apple/apple.html">Apple</a>
                        <a class="dropdown-item" href="/maskmap/index.html">口罩地圖</a>
                        <a class="dropdown-item" href="/pizza/pizza.html">Pizza</a>
                        <a class="dropdown-item" href="/1A2B/1A2B.html">1A2B</a>
                        <a class="dropdown-item" href="/puzzle/index.html">拼圖</a>
                        <a class="dropdown-item" href="/statistics/index.html">統計</a>
                    </div>
                </li>
            </ul>
        </div>

        <button class="btn" data-container="body" data-toggle="popover" data-placement="left" data-content="EAT ME!">
            <a class="navbar d-flex " href="#"><img src="/computer/img/ice-cream.png" width="30" height="30" class=""
                    alt="" loading="lazy"></a>
        </button>
    </nav>
    <!-- ----------------------上方導覽------------------------- -->

  



    <div id="map"></div>





    <!-- <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script> -->
    <!-- --------------地圖--------------- -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDul5gkZnfeeF7uaTsGGWGqZxhY9JGOh1M&callback=initMap&libraries=&v=weekly"
        defer></script>

    <script>
        let map;
        var markers = [];
        const cities = document.querySelector('#cities');
        const area = document.querySelector('#area');
        const storeList = document.querySelector('#store-list');

        function initMap() {
            var myLatlng = {
                    lat: 25.0415956,
                    lng: 121.5341098
                },
                map = new google.maps.Map(document.getElementById("map"), {
                    center: myLatlng,
                    zoom: 16,
                    mapTypeId: "terrain",
                    mapTypeControl: false,
                    styles: [{
                        featureType: 'poi.business',
                        stylers: [{
                            visibility: 'off'
                        }]
                    }],
                });
             var image = "../computer/img/ice-cream.png";
             map.data.loadGeoJson(
                 "https://raw.githubusercontent.com/kiang/pharmacies/master/json/points.json", null,
                 function (features) {
                     features.map(function (feature) {
                         var marker = new google.maps.Marker({
                             position: feature.getGeometry().get(),
                             icon: image,
                             zindex:-1,
                             map: map,
                         });
                         markers.push(marker);
                         let infowindow = new google.maps.InfoWindow({
                             content: `<h6>${feature.getProperty('name')}</h6>`,
                             maxWidth: 450,
                             
                         });
                         marker.addListener("click", () => {
                             infowindow.open(map, marker)
                             
                         });

                     });
                     /* const clusterOptions = {
                         imagePath: "https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m",
                         gridSize: 130, 
                         zoomOnClick: true, 
                         maxZoom: 15, 
                     }; */
                     var markerCluster = new MarkerClusterer(map, markers, clusterOptions);
                     map.data.setMap(null);

                 
                 })

            map.data.setStyle({
                icon: image,
            });

            getUserLocation(map);
            //getMaskData(map, 'https://raw.githubusercontent.com/kiang/pharmacies/master/json/points.json');
            getCityData('./CityCountyData.json');
        }

        function getMaskData(map, url) {
            let xhr = new XMLHttpRequest();

            xhr.onload = function () {
                if (this.status == 200 && this.readyState == 4) {
                    maskData = JSON.parse(xhr.response);
                    setOptionsEvent(maskData.features, map);
                } else {
                    console.log('Error');
                }
            };
            xhr.open('GET', url);
            xhr.send();
        }

        function getUserLocation(map) {
            if (navigator.geolocation) {
                function showPosition(position) {
                    var myLatLng = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    var marker = new google.maps.Marker({
                        position: myLatLng,
                        icon: '../maskmap/img/market.png',
                        map: map
                    });
                    map.setCenter(myLatLng);
                }

                function showError() {
                    console.log('無法取得你的地理位置。')
                }
                navigator.geolocation.getCurrentPosition(showPosition, showError);
            } else {
                console.log('你的裝置不支援定位功能。');
            }
        }

        function setOptionsEvent(data, map) {
            cities.addEventListener("change", function () {
                storeList.innerHTML = '';
            })

            area.addEventListener("change", function () {
                storeList.innerHTML = '';

                data.forEach(item => {
                    let itemValues = item.properties;
                    let itemLocation = item.geometry.coordinates;
                    if (itemValues.county == cities.value && itemValues.town == area.value) {

                        let card = document.querySelector('#cardTemplate');
                        let cloneContent = card.content.cloneNode(true);
                        cloneContent.querySelector('#shopName').innerText = itemValues.name;
                        cloneContent.querySelector('.fa-eye').setAttribute('data-lat', itemLocation[1]);
                        cloneContent.querySelector('.fa-eye').setAttribute('data-lng', itemLocation[0]);
                        cloneContent.querySelector('#adult').innerText = "成人口罩數量：" + itemValues
                            .mask_adult;
                        cloneContent.querySelector('#child').innerText = "兒童口罩數量：" + itemValues
                            .mask_child;
                        cloneContent.querySelector('#address').innerText = itemValues.name;
                        cloneContent.querySelector('#address').setAttribute('href',
                            `https://www.google.com.tw/maps/place/${itemValues.address}`);
                        cloneContent.querySelector('#phone').innerHTML =
                            '<i class="fas fa-phone-alt"></i>' + itemValues.phone;
                        cloneContent.querySelector('#note').innerHTML =
                            '<i class="far fa-comment-alt"></i>' + itemValues.note;

                        //綁定icon事件
                        cloneContent.querySelector('.fa-eye').addEventListener('click', function () {
                            let newlat = Number(this.dataset.lat);
                            let newlng = Number(this.dataset.lng);
                            map.setCenter({
                                lat: newlat,
                                lng: newlng
                            });
                        })

                        storeList.append(cloneContent);
                    }
                })
            })
        }

        function getCityData(url) {
            let xhr = new XMLHttpRequest();
            xhr.onload = function () {
                if (this.status == 200 && this.readyState == 4) {
                    let geoData = JSON.parse(this.response);
                    let countriesOptions = '';
                    let cytiesOptions = '';
                    countriesOptions = `<button class="btn btn-secondary dropdown-toggle" type="button"
                            id="dropdownMenuButton" id="countries" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            選擇縣市
                        </button>`;
                    geoData.forEach((item, index) => {
                        countriesOptions += `<div id="" value="${item.CityName}" class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                            ${item.CityName}</div>`;

                    });
                    cities.innerHTML = `<div class="dropdown mr-3">
                            ${countriesOptions}
                    </div>`;


                    cities.addEventListener('change', function () {
                        cytiesOptions = '';
                        cytiesOptions = `<button class="btn btn-secondary dropdown-toggle" type="button"
                            id="dropdownMenuButton" id="countries" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            選擇區域
                        </button>`;
                        geoData[cities.selectedIndex - 1].AreaList.forEach(item => {
                            cytiesOptions +=
                                `<div id="" value="${item.AreaName}}" class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                    ${item.AreaName}</div>`;

                        })
                        area.innerHTML = `<div class="dropdown">
                            ${cytiesOptions}
                    </div>`;


                    })
                } else {
                    console.log('Error');
                }
            };
            xhr.open('GET', url);
            xhr.send();
        }
    </script>
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous">
    </script>
    <script>
        $(function () {
            $('[data-toggle="popover"]').popover()
        })
    </script>
</body>

</html>